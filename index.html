<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SES - Sovereign Execution Substrate</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="ses-app">
    <!-- Header -->
    <header class="ses-header">
      <div class="header-left">
        <h1 class="logo">SES</h1>
        <span class="version">v1.0.0</span>
        <span class="tagline">Sovereign Execution Substrate</span>
      </div>
      <div class="header-right">
        <div id="ai-status" class="ai-status">
          <span class="status-offline">○ Checking Ollama...</span>
        </div>
        <div id="status" class="status-badge">Initializing...</div>
      </div>
    </header>

    <!-- Main Layout -->
    <main class="ses-main">
      <!-- Left Panel: Pulse Creation -->
      <section class="panel panel-create" data-testid="pulse-creation-panel">
        <h2 class="panel-title">Create Pulse</h2>
        
        <div class="form-group">
          <label for="function-select">Function</label>
          <select id="function-select" data-testid="function-select">
            <option value="fibonacci">Loading...</option>
          </select>
        </div>

        <div class="form-group">
          <label for="pulse-input">Input (JSON)</label>
          <textarea id="pulse-input" data-testid="pulse-input" rows="3" placeholder='{"n": 10}'>{"n": 15}</textarea>
        </div>

        <div class="bounds-config">
          <h3>Resource Bounds</h3>
          
          <div class="bound-slider">
            <label>Max Steps: <span id="max-steps-label">10,000</span></label>
            <input type="range" id="max-steps" min="100" max="100000" value="10000" data-testid="max-steps-slider">
          </div>
          
          <div class="bound-slider">
            <label>Max Memory: <span id="max-memory-label">10 MB</span></label>
            <input type="range" id="max-memory" min="1048576" max="104857600" value="10485760" data-testid="max-memory-slider">
          </div>
          
          <div class="bound-slider">
            <label>Max Branch Depth: <span id="max-branches-label">50</span></label>
            <input type="range" id="max-branches" min="5" max="200" value="50" data-testid="max-branches-slider">
          </div>
          
          <div class="bound-slider">
            <label>Max Time: <span id="max-time-label">10000ms</span></label>
            <input type="range" id="max-time" min="1000" max="60000" value="10000" data-testid="max-time-slider">
          </div>
        </div>

        <div class="button-group">
          <button id="create-pulse-btn" class="btn btn-primary" data-testid="create-pulse-btn">
            Create Pulse
          </button>
          <button id="execute-pulse-btn" class="btn btn-execute" disabled data-testid="execute-pulse-btn">
            Execute
          </button>
        </div>

        <div class="button-group">
          <button id="replay-btn" class="btn btn-secondary" disabled data-testid="replay-btn">
            Replay
          </button>
          <button id="verify-btn" class="btn btn-secondary" disabled data-testid="verify-btn">
            Verify
          </button>
          <button id="ai-analyze-btn" class="btn btn-ai" disabled data-testid="ai-analyze-btn">
            AI Analyze
          </button>
        </div>

        <!-- NEW: Layer 3 Core Controls -->
        <div class="layer3-controls">
          <h3>Layer 3 Core Operations</h3>
          
          <div class="button-group">
            <button id="validate-pulse-btn" class="btn btn-secondary" data-testid="validate-pulse-btn">
              Validate Pulse Schema
            </button>
            <button id="inspect-cid-btn" class="btn btn-secondary" data-testid="inspect-cid-btn">
              Inspect CID Store
            </button>
          </div>

          <div class="button-group">
            <button id="export-store-btn" class="btn btn-secondary" data-testid="export-store-btn">
              Export Content Store
            </button>
            <button id="import-store-btn" class="btn btn-secondary" data-testid="import-store-btn">
              Import Content Store
            </button>
          </div>
        </div>

        <button id="clear-btn" class="btn btn-danger btn-small" data-testid="clear-btn">
          Clear All Data
        </button>
      </section>

      <!-- Center Panel: Execution Visualization -->
      <section class="panel panel-execution" data-testid="execution-panel">
        <h2 class="panel-title">Execution</h2>

        <!-- Resource Bounds Display -->
        <div class="bounds-display" data-testid="bounds-display">
          <h3>Resource Usage</h3>
          
          <div class="bound-meter">
            <div class="bound-label">
              <span>Steps</span>
              <span id="steps-value">0 / 10,000</span>
            </div>
            <div class="progress-container">
              <div id="steps-progress" class="progress-bar" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="bound-meter">
            <div class="bound-label">
              <span>Memory</span>
              <span id="memory-value">0 B / 10 MB</span>
            </div>
            <div class="progress-container">
              <div id="memory-progress" class="progress-bar" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="bound-meter">
            <div class="bound-label">
              <span>Branch Depth</span>
              <span id="branch-value">0 / 50</span>
            </div>
            <div class="progress-container">
              <div id="branch-progress" class="progress-bar" style="width: 0%"></div>
            </div>
          </div>
          
          <div class="bound-meter">
            <div class="bound-label">
              <span>Time</span>
              <span id="time-value">0ms / 10000ms</span>
            </div>
            <div class="progress-container">
              <div id="time-progress" class="progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <!-- CID Display -->
        <div class="cid-section" data-testid="cid-display">
          <h3>Content Identifiers (CIDs)</h3>
          <div id="pulse-display" class="pulse-display">
            <p class="placeholder">Create a pulse to see CIDs...</p>
          </div>
        </div>

        <!-- NEW: Schema Validation Display -->
        <div class="validation-section">
          <h3>Schema Validation</h3>
          <div id="validation-display" class="validation-display" data-testid="validation-display">
            <p class="placeholder">Validate a pulse to see schema compliance...</p>
          </div>
        </div>

        <!-- Trace Display -->
        <div class="trace-section">
          <h3>Execution Trace</h3>
          <div id="trace-display" class="trace-display" data-testid="trace-display">
            <p class="placeholder">Execute a pulse to see trace...</p>
          </div>
        </div>

        <!-- Output Display -->
        <div class="output-section">
          <h3>Output</h3>
          <div id="output-display" class="output-display" data-testid="output-display">
            <p class="placeholder">Execute a pulse to see output...</p>
          </div>
        </div>
      </section>

      <!-- Right Panel: Results & AI -->
      <section class="panel panel-results" data-testid="results-panel">
        <h2 class="panel-title">Verification & AI</h2>

        <!-- NEW: Content Store Inspector -->
        <div class="result-section">
          <h3>Content Store</h3>
          <div id="store-inspector" data-testid="store-inspector">
            <p class="placeholder">Content-addressed storage viewer...</p>
            <div id="store-stats" class="store-stats"></div>
            <div id="store-contents" class="store-contents"></div>
          </div>
        </div>

        <!-- Replay Result -->
        <div class="result-section">
          <h3>Replay Result</h3>
          <div id="replay-result" data-testid="replay-result">
            <p class="placeholder">Replay a pulse to verify determinism...</p>
          </div>
        </div>

        <!-- Verify Result -->
        <div class="result-section">
          <h3>Verification Result</h3>
          <div id="verify-result" data-testid="verify-result">
            <p class="placeholder">Verify a pulse for deterministic replay...</p>
          </div>
        </div>

        <!-- AI Response -->
        <div class="ai-section">
          <h3>AI Analysis (Ollama Layer)</h3>
          <div id="ai-response" class="ai-response" data-testid="ai-response">
            <p class="placeholder">AI analysis is separate from DCX runtime.<br>Results are CID-wrapped for reproducibility.</p>
          </div>
        </div>

        <!-- Pulse History -->
        <div class="history-section">
          <h3>Recent Pulses</h3>
          <div id="pulse-list" class="pulse-list" data-testid="pulse-list">
            <p class="placeholder">No pulses yet...</p>
          </div>
        </div>
      </section>
    </main>

    <!-- Log Panel -->
    <footer class="ses-footer">
      <div class="log-container">
        <h3>System Log</h3>
        <div id="log" class="log" data-testid="system-log"></div>
      </div>
    </footer>

    <!-- Architecture Info -->
    <aside class="architecture-info" data-testid="architecture-info">
      <h3>SES Core Invariants</h3>
      <ul>
        <li>✓ Every state change originates from a Pulse</li>
        <li>✓ No unbounded execution anywhere</li>
        <li>✓ All results replayable from CIDs</li>
        <li>✓ Resource use explicit and capped</li>
        <li>✓ Parallelism is bounded</li>
        <li>✓ AI is above DCX, never inside</li>
      </ul>
      
      <!-- NEW: Layer 3 Status -->
      <div class="layer3-status">
        <h4>Layer 3 Core Status</h4>
        <div id="layer3-info">
          <p>Schema Version: <span id="schema-version">-</span></p>
          <p>Store Size: <span id="store-size">0</span> items</p>
          <p>Runtime: <span id="runtime-status">Not initialized</span></p>
        </div>
      </div>
    </aside>
  </div>

  <!-- Hidden file input for import -->
  <input type="file" id="import-file-input" accept=".json" style="display: none;">

  <!-- Load SES Layer 3 Core modules FIRST (order matters!) -->
  <script src="ses/pulse-schema.js"></script>
  <script src="ses/content-store.js"></script>
  <script src="ses/dcx-runtime.js"></script>
  <script src="ses/index.js"></script>
  
  <!-- Then load additional SES modules -->
  <script src="ses/ses-core.js"></script>
  <script src="ses/ses-store.js"></script>
  <script src="ses/ses-context.js"></script>
  <script src="ses/ses-flow.js"></script>
  <script src="ses/ses-ai.js"></script>
  
  <!-- Load UI last to ensure all modules are available -->
  <script src="ses/ses-ui.js"></script>
  
  <!-- NEW: Layer 3 UI Integration -->
  <script src="ses/ses-layer3-ui.js"></script>
</body>
</html>
